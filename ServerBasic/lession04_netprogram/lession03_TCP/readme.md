# TCP通信流程
## 通信流程
```C
// TCP 和 UDP -> 传输层的协议
UDP:用户数据报协议，面向无连接，可以单播，多播，广播， 面向数据报，不可靠
TCP:传输控制协议，面向连接的，可靠的，基于字节流，仅支持单播传输
                    UDP                           TCP
是否创建连接        无连接                         面向连接
是否可靠            不可靠                         可靠的
连接的对象个数 一对一、一对多、多对一、多对多         支持一对一
传输的方式          面向数据报                     面向字节流
首部开销            8个字节                      最少20个字节
适用场景        实时应用（视频会议，直播）      可靠性高的应用（文件传输）
```
![TCP通信流程](TCP%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B.png)
```C
// TCP 通信的流程
// 服务器端 （被动接受连接的角色）
1. 创建一个用于监听的套接字
- 监听：监听有客户端的连接
- 套接字：这个套接字其实就是一个文件描述符
2. 将这个监听文件描述符和本地的IP和端口绑定（IP和端口就是服务器的地址信息）
- 客户端连接服务器的时候使用的就是这个IP和端口
3. 设置监听，监听的fd开始工作
4. 阻塞等待，当有客户端发起连接，解除阻塞，接受客户端的连接，会得到一个和客户端通信的套接字（fd）
5. 通信
- 接收数据
- 发送数据
6. 通信结束，断开连接
```
```C
// 客户端
1. 创建一个用于通信的套接字（fd）
2. 连接服务器，需要指定连接的服务器的 IP 和 端口
3. 连接成功了，客户端可以直接和服务器通信
- 接收数据
- 发送数据
4. 通信结束，断开连接
```
## TCP三次握手
![过程](%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E5%92%8C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png)
## TCP滑动窗口
```C
# mss: Maximum Segment Size(一条数据的最大的数据量)
# win: 滑动窗口
1. 客户端向服务器发起连接，客户单的滑动窗口是4096，一次接收或者发送的最大数据量是1460
2. 服务器接收连接情况，告诉客户端服务器的窗口大小是6144，一次接收或者发送的最大数据量是1024
3. 第三次握手
4. 4-9 客户端连续给服务器发送了6k的数据，每次发送1k(因为服务器的最大处理量就是1K)
5. 第10次，服务器告诉客户端：发送的6k数据以及接收到，存储在缓冲区中，缓冲区数据已经处理了2k,窗口大小是2k
6. 第11次，服务器告诉客户端：发送的6k数据以及接收到，存储在缓冲区中，缓冲区数据已经处理了4k,窗口大小是4k
7. 第12次，客户端给服务器发送了1k的数据
8. 第13次，客户端主动请求和服务器断开连接，并且给服务器发送了1k的数据
9. 第14次，服务器回复ACK 8194, a:同意断开连接的请求 b:告诉客户端已经接受到方才发的2k的数据c:滑动窗口2k
10.第15、16次，通知客户端滑动窗口的大小
11.第17次，第三次挥手，服务器端给客户端发送FIN,请求断开连接
12.第18次，第四次回收，客户端同意了服务器端的断开请求
```
### TCP通信并发

### TCP状态转换

### 端口复用
端口复用最常用的用途是:
1.防止服务器重启时之前绑定的端口还未释放  
2.程序突然退出而系统没有释放端口
```
#include <sys/types.h>
#include <sys/socket.h>
// 设置套接字的属性（不仅仅能设置端口复用）
int setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);

参数：
    - sockfd : 要操作的文件描述符
    - level : 级别 - SOL_SOCKET (端口复用的级别)
    - optname : 选项的名称
    - SO_REUSEADDR
    - SO_REUSEPORT
    - optval : 端口复用的值（整形）
    - 1 : 可以复用
    - 0 : 不可以复用
    - optlen : optval参数的大小

端口复用，设置的时机是在服务器绑定端口之前。
setsockopt();
bind();
```
```
常看网络相关信息的命令
    netstat
参数：
    -a 所有的socket
    -p 显示正在使用socket的程序的名称
    -n 直接使用IP地址，而不通过域名服务器
```